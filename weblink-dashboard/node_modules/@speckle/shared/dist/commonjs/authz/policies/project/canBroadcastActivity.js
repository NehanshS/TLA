"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.canBroadcastProjectActivityPolicy = void 0;
const result_1 = require("true-myth/result");
const projects_js_1 = require("../../fragments/projects.js");
const server_js_1 = require("../../fragments/server.js");
const canBroadcastProjectActivityPolicy = (loaders) => async ({ userId, projectId }) => {
    // Ensure logged in
    const ensuredServerRole = await (0, server_js_1.ensureMinimumServerRoleFragment)(loaders)({
        userId
    });
    if (ensuredServerRole.isErr) {
        return (0, result_1.err)(ensuredServerRole.error);
    }
    // If publicly readable - any authed user can broadcast
    const isPubliclyReadable = await (0, projects_js_1.checkIfPubliclyReadableProjectFragment)(loaders)({
        projectId
    });
    if (isPubliclyReadable.isErr) {
        return (0, result_1.err)(isPubliclyReadable.error);
    }
    if (isPubliclyReadable.value)
        return (0, result_1.ok)();
    // Not public. Ensure user has at least implicit membership & read access
    const hasReadAccess = await (0, projects_js_1.ensureImplicitProjectMemberWithReadAccessFragment)(loaders)({
        userId,
        projectId
    });
    if (hasReadAccess.isErr) {
        return (0, result_1.err)(hasReadAccess.error);
    }
    return (0, result_1.ok)();
};
exports.canBroadcastProjectActivityPolicy = canBroadcastProjectActivityPolicy;
//# sourceMappingURL=canBroadcastActivity.js.map