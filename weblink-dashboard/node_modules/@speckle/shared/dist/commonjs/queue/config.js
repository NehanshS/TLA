"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.initializeQueue = void 0;
const bull_1 = __importDefault(require("bull"));
const ioredis_1 = require("ioredis");
const isRedisReady_js_1 = require("../redis/isRedisReady.js");
const clientCache = {};
const initializeQueue = async ({ queueName, redisUrl, options }) => {
    if (!(redisUrl in clientCache))
        clientCache[redisUrl] = {};
    const opts = {
        ...options,
        // redisOpts here will contain at least a property of connectionName which will identify the queue based on its name
        createClient(type, redisOpts) {
            switch (type) {
                case 'client':
                    if (redisUrl in clientCache && clientCache[redisUrl].client !== undefined) {
                        return clientCache[redisUrl].client;
                    }
                    else {
                        const client = new ioredis_1.Redis(redisUrl, redisOpts ?? {});
                        clientCache[redisUrl].client = client;
                        return client;
                    }
                case 'subscriber':
                    if (redisUrl in clientCache &&
                        clientCache[redisUrl].subscriber !== undefined) {
                        return clientCache[redisUrl].subscriber;
                    }
                    else {
                        const subscriber = new ioredis_1.Redis(redisUrl, {
                            ...redisOpts,
                            maxRetriesPerRequest: null,
                            enableReadyCheck: false
                        });
                        clientCache[redisUrl].subscriber = subscriber;
                        return subscriber;
                    }
                case 'bclient':
                    return new ioredis_1.Redis(redisUrl, {
                        ...redisOpts,
                        maxRetriesPerRequest: null,
                        enableReadyCheck: false
                    });
                default:
                    throw new Error(`Unexpected connection type: ${type}`);
            }
        }
    };
    const newQueue = new bull_1.default(queueName, opts);
    // bull does not check if redis is ready...
    //
    // logger.info('Checking Redis connection is ready...')
    if (!clientCache[redisUrl].client)
        throw new Error('Redis client not properly initialized');
    await (0, isRedisReady_js_1.isRedisReady)(clientCache[redisUrl].client);
    // await isRedisReady(clientCache[redisUrl].subscriber)
    return await newQueue.isReady();
};
exports.initializeQueue = initializeQueue;
//# sourceMappingURL=config.js.map